<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calibrating `heemod` models • heemod</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibrating `heemod` models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">heemod</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a_introduction.html">An Introduction to `heemod`</a></li>
    <li><a class="dropdown-item" href="../articles/b_time_dependency.html">Time-varying values</a></li>
    <li><a class="dropdown-item" href="../articles/c_homogeneous.html">Simple Markov Models (Homogeneous)</a></li>
    <li><a class="dropdown-item" href="../articles/d_non_homogeneous.html">Time-varying Markov Models (Non-Homogeneous)</a></li>
    <li><a class="dropdown-item" href="../articles/e_probabilistic.html">Probabilistic Uncertainty Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/f_sensitivity.html">Deterministic Sensitivity Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/g_heterogeneity.html">Heterogeneity &amp; Demographic Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/h_tabular.html">Tabular Input</a></li>
    <li><a class="dropdown-item" href="../articles/i_reproduction.html">Reproducing Exact Results from DMHEE</a></li>
    <li><a class="dropdown-item" href="../articles/j_survival_2_psa.html">Survival Models Part 2 - PSA</a></li>
    <li><a class="dropdown-item" href="../articles/j_survival.html">Survival models</a></li>
    <li><a class="dropdown-item" href="../articles/k_calibration.html">Calibrating `heemod` models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/aphp/heemod/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calibrating `heemod` models</h1>
            
            <h4 data-toc-skip class="date">2024-09-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/aphp/heemod/blob/master/vignettes/k_calibration.Rmd" class="external-link"><code>vignettes/k_calibration.Rmd</code></a></small>
      <div class="d-none name"><code>k_calibration.Rmd</code></div>
    </div>

    
    
<p>The parameters for health economic models can be difficult to
measure, either because they cannot be observed directly, or because
appropriate data are not systematically gathered in the area of
interest. When expected model results are know, <em>model
calibration</em> is the search for the appropriate value of initially
unknown parameters that allow to obtain these results.</p>
<p>For example the shape and scale parameters of a Weibull survival
model can be unknown parameter values. But from the litterature we can
know the expected probability of being alive at time <em>t</em>. If this
probability is a result from the model, we can find the value of the
shape and scale parameters that allow the model results to match, as
closely as possible, the observed probability of being alive.</p>
<p>In order to perform calibration, the user must provide:</p>
<ol style="list-style-type: decimal">
<li>A heemod object from <code><a href="../reference/run_model.html">run_model()</a></code> of
<code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Calibrating models from &lt;code&gt;&lt;a href="https://rdrr.io/r/stats/update.html" class="external-link"&gt;update()&lt;/a&gt;&lt;/code&gt; is
&lt;em&gt;extremely&lt;/em&gt; time-consuming.&lt;/p&gt;'><sup>1</sup></a>.</li>
<li>The names of the parameters of the model to calibrate (the
parameters for which we seek appropriate values).</li>
<li>A function that when applied to the model returns the result we want
to match with reference values.</li>
<li>The target values we would like the model results to match.</li>
</ol>
<p>For this example we will use the result from the assessment of a new
total hip replacement previously described in
<code>vignette("d-non-homogeneous", "heemod")</code>.</p>
<p>We will calibrate the parameters <code>gamma</code> (a Weibull
survival parameter) and <code>rrNP1</code> (the relative risk associated
with the new treatment), which originally have values of 1.45 and 0.26
respectively.</p>
<p>The original number of patients with a THR revision after 20 cycles
are found in this way:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/get_counts.html">get_counts</a></span><span class="op">(</span><span class="va">res_mod</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model_time</span> <span class="op">==</span> <span class="fl">20</span> <span class="op">&amp;</span> <span class="va">state_names</span> <span class="op">==</span> <span class="st">"RevisionTHR"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">##   .strategy_names model_time state_names count</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> standard                20 RevisionTHR 2.69 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> np1                     20 RevisionTHR 0.714</span></span></code></pre>
<p>We want to calibrate <code>gamma</code> and <code>rrNP1</code> to
obtain 3 patients for the <code>standard</code> strategy and 1 patient
for the <code>np1</code> strategy at time 20. We need to define a
function to extract the values we want to change from the model and
return them as a numeric vector:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extract_values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/get_counts.html">get_counts</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>    <span class="va">model_time</span> <span class="op">==</span> <span class="fl">20</span> <span class="op">&amp;</span> <span class="va">state_names</span> <span class="op">==</span> <span class="st">"RevisionTHR"</span></span>
<span>  <span class="op">)</span><span class="op">$</span><span class="va">count</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">extract_values</span><span class="op">(</span><span class="va">res_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.687124 0.714282</span></span></code></pre>
<p>Any arbitrary function of any model output would work, as long as it
returns numeric values.</p>
<p>A convenience function <code><a href="../reference/define_calibration_fn.html">define_calibration_fn()</a></code> exists to
help easily define calibration functions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calib_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/define_calibration_fn.html">define_calibration_fn</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="st">"count"</span>,</span>
<span>  strategy_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"standard"</span>, <span class="st">"np1"</span><span class="op">)</span>,</span>
<span>  element_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RevisionTHR"</span>, <span class="st">"RevisionTHR"</span><span class="op">)</span>,</span>
<span>  cycles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">calib_fn</span><span class="op">(</span><span class="va">res_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.687124 0.714282</span></span></code></pre>
<p>We can now call <code><a href="../reference/calibrate_model.html">calibrate_model()</a></code>, and give the values
we want to reach as <code>target_values</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_model.html">calibrate_model</a></span><span class="op">(</span></span>
<span>  <span class="va">res_mod</span>,</span>
<span>  parameter_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="st">"rrNP1"</span><span class="op">)</span>,</span>
<span>  fn_values <span class="op">=</span> <span class="va">extract_values</span>,</span>
<span>  target_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required namespace: optimx</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_cal</span></span></code></pre></div>
<pre><code><span><span class="co">##      gamma     rrNP1        value convcode</span></span>
<span><span class="co">## 1 1.431919 0.3146302 3.346417e-10        0</span></span></code></pre>
<p>The new parameter values are 1.43 for <code>gamma</code> and 0.31 for
<code>rrNP1</code>. The <code>convcode</code> code at 0 indicates the
calibration was successful.</p>
<p>It is possible to specify several possible starting values for the
calibration procedure in order to explore the parameter space:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.0</span>, <span class="fl">1.5</span>, <span class="fl">2.0</span><span class="op">)</span>,</span>
<span>  rrNP1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">res_cal_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calibrate_model.html">calibrate_model</a></span><span class="op">(</span></span>
<span>  <span class="va">res_mod</span>,</span>
<span>  parameter_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="st">"rrNP1"</span><span class="op">)</span>,</span>
<span>  fn_values <span class="op">=</span> <span class="va">extract_values</span>,</span>
<span>  target_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  initial_values <span class="op">=</span> <span class="va">start</span>,</span>
<span>  lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Additional options to control the optimization process can be passed
to <code><a href="../reference/calibrate_model.html">calibrate_model()</a></code>. These options are parameters of the
<a href="https://CRAN.R-project.org/package=optimx" class="external-link">optimx</a> function,
such as <code>upper</code> and <code>lower</code> to specify upper and
lower values, <code>method</code> to change the optimization method,
etc.</p>
<p>Calibration uses optimization to minimize the sum of squared errors
between calculated and desired values, and so is subject to all the many
difficulties of optimization. Different optimization methods, for
example Nelder-Mead (which does not require gradients) and BFGS or
conjugate gradient methods, which do require gradients but can
approximate them numerically, may work better for different problems.
Some attempted optimizations may not converge.</p>
<p>It may be impossible to evaluate the function at badly-specified
initial parameter values (for example, if a negative initial value is
given for a parameter that must be positive); using box limits on some
parameters may help with this.</p>
<p>Even if the calibration converges from different initial values, it
may not converge to the same parameter values every time; in general, an
underconstrained model can have different parameter sets that fit
equally well. For these and other reasons, the user is advised to
carefully check the results of calibrations.</p>

  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Zarca, Antoine Filipovic-Pierucci.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
